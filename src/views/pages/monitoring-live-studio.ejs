<% layout("layouts/main") %>
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-cyan-50">
  <!-- Monitoring Table -->
  <div class="flex flex-wrap -mx-3">
    <div class="flex-none w-full max-w-full px-3">
      <div class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-0 border-transparent border-solid rounded-2xl bg-clip-border shadow-soft-xl">
        <div class="p-6 pb-0 mb-0 bg-gradient-to-r from-blue-600 to-cyan-500 border-b-0 border-b-solid rounded-t-2xl border-b-transparent">
          <div class="flex flex-wrap justify-between items-center">
            <h6 class="text-white">Live Monitoring - Studio <span id="studio-name" class="font-bold"></span></h6>
            <div class="">
              <button id="start-monitor-btn"
                class="px-4 py-2 mr-2 text-xs font-bold text-white uppercase transition-all bg-gradient-to-tl from-green-600 to-emerald-400 rounded-lg ease-soft-in tracking-tight-soft shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                Proses Monitor Live
              </button>
              <button id="stop-monitor-btn" disabled
                class="px-4 py-2 mr-2 text-xs font-bold text-white uppercase transition-all bg-gradient-to-tl from-red-600 to-rose-400 rounded-lg ease-soft-in tracking-tight-soft shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                Stop
              </button>
              <button id="refresh-btn"
                class="px-4 py-2 text-xs font-bold text-white uppercase transition-all bg-gradient-to-tl from-purple-600 to-pink-400 rounded-lg ease-soft-in tracking-tight-soft shadow-soft-md bg-150 bg-x-25 hover:scale-102 active:opacity-85">
                Refresh
              </button>
            </div>  
          </div>
          
          <!-- Search Bar -->
          <div class="mt-4 mb-4">
            <div class="relative flex items-center max-w-md">
              <input type="text" id="search-input" placeholder="Cari data..." class="pl-10 pr-4 py-2 text-sm leading-normal text-slate-700 border border-gray-300 rounded-lg bg-white bg-clip-border focus:shadow-soft-primary-outline ease-soft-in outline-none transition-all focus:border-cyan-400 focus:outline-none" />
              <div class="absolute left-3 text-slate-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex-auto px-0 pt-0 pb-2 bg-gradient-to-br from-blue-50 to-cyan-50">
          <div class="p-0 overflow-x-auto">
            <table class="items-center w-full mb-0 align-top border-gray-200 text-slate-700">
              <thead class="align-bottom">
                <tr class="bg-gradient-to-r from-blue-500 to-cyan-400 text-white">
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">No</th>
                  <th class="px-6 py-3 font-bold text-left uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Nama</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">GMV</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Order</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Check Out</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Keranjang</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">View</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Ditonton</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Like</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Comment</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Share</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Tanggal</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Durasi</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Status</th>
                  <th class="px-6 py-3 font-bold text-center uppercase align-middle shadow-none text-xxs border-none tracking-none whitespace-nowrap">Pelanggaran</th>
                </tr>
              </thead>
              <tbody id="monitoring-table-body" class="divide-y divide-gray-200">
                <!-- Data will be loaded dynamically -->
                <tr class="bg-white hover:bg-blue-50 transition-colors duration-150">
                  <td colspan="15" class="text-center py-8">
                    <div class="flex justify-center items-center">
                      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                      <span class="ml-3 text-blue-600">Memuat data...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables
  let monitoringInterval;
  let currentData = [];
  let isMonitoring = false;
  const refreshInterval = 10000; // 10 seconds
  const studioId = '<%= studioId %>'; // Get studioId from EJS

  // DOM Ready
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize with studio data
    loadStudioData();
    
    // Setup event listeners
    document.getElementById('start-monitor-btn').addEventListener('click', startMonitoring);
    document.getElementById('stop-monitor-btn').addEventListener('click', stopMonitoring);
    document.getElementById('refresh-btn').addEventListener('click', refreshData);
    document.getElementById('search-input').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      filterData(searchTerm);
    });
  });

  // Start monitoring function
  function startMonitoring() {
    if (isMonitoring) return;
    
    isMonitoring = true;
    document.getElementById('start-monitor-btn').disabled = true;
    document.getElementById('stop-monitor-btn').disabled = false;
    
    // Add animation to indicate monitoring is active
    document.getElementById('stop-monitor-btn').classList.add('pulse-animation');
    
    // Initial fetch
    fetchMonitoringData();
    
    // Set up interval
    monitoringInterval = setInterval(fetchMonitoringData, refreshInterval);
  }

  // Stop monitoring function
  function stopMonitoring() {
    if (!isMonitoring) return;
    
    clearInterval(monitoringInterval);
    isMonitoring = false;
    document.getElementById('start-monitor-btn').disabled = false;
    document.getElementById('stop-monitor-btn').disabled = true;
    
    // Remove animation
    document.getElementById('stop-monitor-btn').classList.remove('pulse-animation');
  }

  // Refresh data function (stops monitoring and reloads)
  function refreshData() {
    stopMonitoring();
    
    // Add refresh animation
    const refreshBtn = document.getElementById('refresh-btn');
    refreshBtn.classList.add('rotate-animation');
    setTimeout(() => {
      refreshBtn.classList.remove('rotate-animation');
    }, 1000);
    
    loadStudioData();
  }

  // Fetch monitoring data from API
  async function fetchMonitoringData() {
    try {
      const response = await fetch(`/api/studio/${studioId}`);
      if (!response.ok) throw new Error('Gagal memuat data monitoring');
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.message || 'Gagal memuat data');
      }
      
      // Update studio name
      if (result.studio) {
        document.getElementById('studio-name').textContent = result.studio.nama_studio || `ID: ${result.studio.id}`;
      }
      
      // Transform data to match our table structure
      const transformedData = result.data.map((item, index) => ({
        id: index,
        nama: item.nama || "-",
        gmv: item.placedGmv || "-",
        order: item.pesanan || 0,
        checkout: item.confirmedItemSold || 0,
        keranjang: item.atc || 0,
        view: item.views || 0,
        ditonton: item.ditonton || 0,
        like: item.likes || 0,
        comment: item.comments || 0,
        share: item.shares || 0,
        tanggal: new Date().toLocaleDateString('id-ID'),
        durasi: item.durasiFormatted || "-",
        status: item.statusText || "-",
        pelanggaran: item.pelanggaran || { jumlah: 0, judul: [] }
      }));
      
      // Update only if we have new data
      if (JSON.stringify(transformedData) !== JSON.stringify(currentData)) {
        currentData = transformedData;
        updateTableData(transformedData);
      }
    } catch (error) {
      console.error('Error fetching monitoring data:', error);
      // Don't stop monitoring on error, just log it
    }
  }

  // Load studio data from API (initial load)
  async function loadStudioData() {
    try {
      // Show loading state
      document.getElementById('monitoring-table-body').innerHTML = `
        <tr class="bg-white hover:bg-blue-50 transition-colors duration-150">
          <td colspan="15" class="text-center py-8">
            <div class="flex justify-center items-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
              <span class="ml-3 text-blue-600">Memuat data studio...</span>
            </div>
          </td>
        </tr>
      `;
      
      // Fetch studio data from API
      const response = await fetch(`/api/studio/${studioId}`);
      if (!response.ok) throw new Error('Gagal memuat data studio');
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.message || 'Gagal memuat data studio');
      }
      
      // Update studio name
      if (result.studio) {
        document.getElementById('studio-name').textContent = result.studio.nama_studio || `ID: ${result.studio.id}`;
      }
      
      // Transform data to monitoring table format
      const monitoringData = result.data.map((item, index) => ({
        id: index,
        nama: item.nama || "-",
        gmv: item.placedGmv || "-",
        order: item.pesanan || 0,
        checkout: item.confirmedItemSold || 0,
        keranjang: item.atc || 0,
        view: item.views || 0,
        ditonton: item.ditonton || 0,
        like: item.likes || 0,
        comment: item.comments || 0,
        share: item.shares || 0,
        tanggal: new Date().toLocaleDateString('id-ID'),
        durasi: item.durasiFormatted || "-",
        status: item.statusText || "-",
        pelanggaran: item.pelanggaran || { jumlah: 0, judul: [] }
      }));
      
      currentData = monitoringData;
      renderData(monitoringData);
    } catch (error) {
      console.error('Error:', error);
      document.getElementById('monitoring-table-body').innerHTML = `
        <tr class="bg-white hover:bg-blue-50 transition-colors duration-150">
          <td colspan="15" class="text-center py-8 text-red-500">
            <div class="flex flex-col items-center">
              <svg class="w-12 h-12 text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Gagal memuat data studio: ${error.message}</span>
            </div>
          </td>
        </tr>
      `;
    }
  }

  // Update table data without re-rendering the whole table
  function updateTableData(data) {
    const tbody = document.getElementById('monitoring-table-body');
    const rows = tbody.querySelectorAll('tr');
    
    data.forEach((item, index) => {
      if (rows[index]) {
        // Update each cell individually
        const cells = [
          '.nama-cell', '.gmv-cell', '.order-cell', '.checkout-cell', 
          '.keranjang-cell', '.view-cell', '.ditonton-cell', '.like-cell',
          '.comment-cell', '.share-cell', '.tanggal-cell', '.durasi-cell'
        ];
        
        const values = [
          item.nama, item.gmv, item.order, item.checkout,
          item.keranjang, item.view, item.ditonton, item.like,
          item.comment, item.share, item.tanggal, item.durasi
        ];
        
        cells.forEach((cellClass, i) => {
          const cell = rows[index].querySelector(cellClass);
          if (cell) cell.textContent = values[i];
        });
        
        // Update status cell
        const statusCell = rows[index].querySelector('.status-cell');
        if (statusCell) {
          statusCell.textContent = item.status;
          statusCell.className = `p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent text-xs font-semibold leading-tight ${getStatusColor(item.status)}`;
        }
        
        // Update violation cell
        const violationCell = rows[index].querySelector('.pelanggaran-cell');
        if (violationCell) {
          const violationCount = item.pelanggaran?.jumlah || 0;
          const violationTitles = item.pelanggaran?.judul || [];
          
          violationCell.innerHTML = violationCount > 0 
            ? `<span class="relative group cursor-pointer ${getViolationColor(violationCount)}">
                 ${violationCount}
                 <div class="absolute invisible group-hover:visible z-50 w-64 p-2 text-xs bg-gray-800 text-white rounded shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-2">
                   <div class="font-bold mb-1">Detail Pelanggaran:</div>
                   ${violationTitles.length > 0 
                     ? violationTitles.map(title => `<div class="mb-1">• ${title}</div>`).join('') 
                     : '<div>Tidak ada detail pelanggaran</div>'
                   }
                 </div>
               </span>`
            : `<span class="${getViolationColor(violationCount)}">${violationCount}</span>`;
        }
      }
    });
  }

  // Render data to table (initial render)
  function renderData(data) {
    const tbody = document.getElementById('monitoring-table-body');
    
    if (data.length === 0) {
      tbody.innerHTML = `
        <tr class="bg-white hover:bg-blue-50 transition-colors duration-150">
          <td colspan="15" class="text-center py-8">
            <div class="flex flex-col items-center text-gray-500">
              <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Tidak ada data monitoring</span>
            </div>
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = data.map((item, index) => {
      const violationCount = item.pelanggaran?.jumlah || 0;
      const violationTitles = item.pelanggaran?.judul || [];
      const rowColorClass = index % 2 === 0 ? 'bg-blue-50' : 'bg-white';
      
      return `
      <tr class="${rowColorClass} hover:bg-blue-100 transition-colors duration-150">
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent">
          <span class="text-xs font-semibold leading-tight">${index + 1}</span>
        </td>
        <td class="p-2 align-middle bg-transparent border-b whitespace-nowrap shadow-transparent nama-cell">
          <div class="flex px-2 py-1">
            <div class="flex flex-col justify-center">
              <h6 class="mb-0 text-sm leading-normal font-semibold">${item.nama}</h6>
            </div>
          </div>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent gmv-cell">
          <span class="text-xs font-semibold leading-tight text-blue-600">${item.gmv}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent order-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-green-500 rounded-full">${item.order}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent checkout-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-emerald-500 rounded-full">${item.checkout}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent keranjang-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-amber-500 rounded-full">${item.keranjang}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent view-cell">
          <span class="text-xs font-semibold leading-tight text-purple-600">${item.view}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent ditonton-cell">
          <span class="text-xs font-semibold leading-tight text-pink-600">${item.ditonton}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent like-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-500 rounded-full">${item.like}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent comment-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-indigo-500 rounded-full">${item.comment}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent share-cell">
          <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-teal-500 rounded-full">${item.share}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent tanggal-cell">
          <span class="text-xs font-semibold leading-tight text-gray-600">${item.tanggal}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent durasi-cell">
          <span class="text-xs font-semibold leading-tight text-cyan-600">${item.durasi}</span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent status-cell">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(item.status)} ${getStatusBgColor(item.status)}">
            ${item.status}
          </span>
        </td>
        <td class="p-2 text-center align-middle bg-transparent border-b whitespace-nowrap shadow-transparent pelanggaran-cell">
          ${violationCount > 0 
            ? `<span class="relative group cursor-pointer inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getViolationColor(violationCount)} ${getViolationBgColor(violationCount)}">
                 ${violationCount}
                 <div class="absolute invisible group-hover:visible z-50 w-64 p-2 text-xs bg-gray-800 text-white rounded shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-2">
                   <div class="font-bold mb-1">Detail Pelanggaran:</div>
                   ${violationTitles.length > 0 
                     ? violationTitles.map(title => `<div class="mb-1">• ${title}</div>`).join('') 
                     : '<div>Tidak ada detail pelanggaran</div>'
                   }
                 </div>
               </span>`
            : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getViolationColor(violationCount)} ${getViolationBgColor(violationCount)}">${violationCount}</span>`
          }
        </td>
      </tr>
    `}).join('');
  }

  // Helper function for status color
  function getStatusColor(status) {
    if (!status) return 'text-gray-800';
    switch(status.toLowerCase()) {
      case 'aktif': 
      case 'live': 
      case 'sedang live':
        return 'text-green-800';
      case 'nonaktif': 
      case 'tidak live': 
      case 'tidak live':
        return 'text-red-800';
      case 'paused': 
        return 'text-yellow-800';
      default: return 'text-gray-800';
    }
  }

  // Helper function for status background color
  function getStatusBgColor(status) {
    if (!status) return 'bg-gray-100';
    switch(status.toLowerCase()) {
      case 'aktif': 
      case 'live': 
      case 'sedang live':
        return 'bg-green-100';
      case 'nonaktif': 
      case 'tidak live': 
      case 'tidak live':
        return 'bg-red-100';
      case 'paused': 
        return 'bg-yellow-100';
      default: return 'bg-gray-100';
    }
  }

  // Helper function for violation color
  function getViolationColor(violationCount) {
    if (violationCount === 0) return 'text-green-800';
    if (violationCount <= 2) return 'text-yellow-800';
    return 'text-red-800';
  }

  // Helper function for violation background color
  function getViolationBgColor(violationCount) {
    if (violationCount === 0) return 'bg-green-100';
    if (violationCount <= 2) return 'bg-yellow-100';
    return 'bg-red-100';
  }

  // Filter data based on search term
  function filterData(searchTerm) {
    const filteredData = currentData.filter(item => 
      item.nama.toLowerCase().includes(searchTerm)
    );
    
    if (filteredData.length === 0) {
      document.getElementById('monitoring-table-body').innerHTML = `
        <tr class="bg-white hover:bg-blue-50 transition-colors duration-150">
          <td colspan="15" class="text-center py-8">
            <div class="flex flex-col items-center text-gray-500">
              <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Tidak ada data yang cocok</span>
            </div>
          </td>
        </tr>
      `;
    } else {
      renderData(filteredData);
    }
  }
</script>

<style>
  .pulse-animation {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
  }
  
  .rotate-animation {
    animation: rotate 1s ease-in-out;
  }
  
  @keyframes rotate {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  
  /* Custom scrollbar for table */
  .overflow-x-auto::-webkit-scrollbar {
    height: 8px;
  }
  
  .overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #c5c5c5;
    border-radius: 4px;
  }
  
  .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>
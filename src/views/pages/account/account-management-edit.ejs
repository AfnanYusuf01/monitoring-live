<% layout("layouts/main") %>
<div class="min-h-screen bg-gray-50">
  <!-- Header dengan judul dan tombol kembali -->
  <div class="px-6 pt-6">
    <div class="flex flex-wrap justify-between items-center mb-6">
      <div class="flex items-center">
        <a
          href="/account-management"
          class="mr-3 text-gray-500 hover:text-gray-700"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            ></path>
          </svg>
        </a>
        <h6 class="text-xl font-semibold text-gray-800">Edit Akun Shopee</h6>
      </div>
    </div>
  </div>

  <!-- Form container -->
  <div class="flex flex-wrap px-6">
    <div class="w-full">
      <div
        class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-0 border-transparent border-solid rounded-lg"
      >
        <!-- Card header -->
        <div
          class="px-6 py-4 mb-0 bg-white border-b border-gray-200 rounded-t-lg"
        >
          <h6 class="text-lg font-semibold text-gray-800">Form Edit Akun</h6>
        </div>

        <!-- Card body -->
        <div class="flex-auto px-6 py-4">
          <form id="akun-form" action="/api/akun/<%= akun.id %>" method="POST">
            <input type="hidden" name="_method" value="PUT" />

            <div class="mb-4">
              <label
                for="nama-akun"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Nama Akun</label
              >
              <input
                type="text"
                id="nama-akun"
                name="nama_akun"
                value="<%= akun.nama_akun || '' %>"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              />
            </div>

            <div class="mb-4">
              <label
                for="email"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="email"
                value="<%= akun.email || '' %>"
                readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed"
              />
              <p class="text-xs text-gray-500 mt-1">
                Email diambil otomatis dari API Shopee berdasarkan cookie
              </p>
            </div>

            <div class="mb-4">
              <label
                for="phone"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Phone</label
              >
              <input
                type="text"
                id="phone"
                value="<%= akun.phone || '' %>"
                readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed"
              />
              <p class="text-xs text-gray-500 mt-1">
                Nomor telepon diambil otomatis dari API Shopee berdasarkan cookie
              </p>
            </div>

            <div class="mb-4">
              <label
                for="cookie"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Cookie Shopee</label
              >
              <textarea
                id="cookie"
                name="cookie"
                rows="6"
                readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed font-mono text-sm"
              ><%= akun.cookie || '' %></textarea>
              <p class="text-xs text-gray-500 mt-1">
                Cookie dari akun Shopee Affiliate. Tidak dapat diubah melalui form ini.
              </p>
            </div>
          </form>
        </div>

        <!-- Card footer -->
        <div
          class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3"
        >
          <a
            href="/account-management"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors"
          >
            Batal
          </a>
          <button
            id="submit-button"
            type="button"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          >
            Simpan Perubahan
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("akun-form");
    const submitBtn = document.getElementById("submit-button");
    const originalText = submitBtn.textContent;

    submitBtn.addEventListener("click", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        nama_akun: formData.get("nama_akun")
        // Hanya nama_akun yang dikirim, cookie tidak dikirim
      };

      // Tampilkan loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';

      try {
        const response = await fetch(form.action, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          showNotification("Nama akun berhasil diperbarui.", "success");

          // Redirect setelah delay singkat
          setTimeout(() => {
            window.location.href = "/account-management?success=Nama akun berhasil diperbarui";
          }, 1500);
        } else {
          throw new Error(result.error || "Error tidak diketahui");
        }
      } catch (error) {
        console.error("Error:", error);
        showNotification("Gagal memperbarui nama akun: " + error.message, "error");

        // Reset button state
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // Function untuk menampilkan notifikasi
    function showNotification(message, type = "info") {
      // Hapus notifikasi sebelumnya jika ada
      const existingNotification = document.getElementById("notification");
      if (existingNotification) {
        existingNotification.remove();
      }

      const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        warning: "bg-yellow-500",
        info: "bg-blue-500",
      };

      const icons = {
        success: '<i class="fas fa-check-circle mr-2"></i>',
        error: '<i class="fas fa-exclamation-circle mr-2"></i>',
        warning: '<i class="fas fa-exclamation-triangle mr-2"></i>',
        info: '<i class="fas fa-info-circle mr-2"></i>',
      };

      const notification = document.createElement("div");
      notification.id = "notification";
      notification.className = `fixed top-4 right-4 flex items-center px-4 py-3 rounded-lg shadow-lg ${colors[type]} text-white z-50 transform transition-transform duration-300 translate-x-full`;
      notification.innerHTML = `${icons[type]}<span>${message}</span>`;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.remove("translate-x-full");
        notification.classList.add("translate-x-0");
      }, 10);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.remove("translate-x-0");
          notification.classList.add("translate-x-full");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }, 5000);
    }
  });
</script>